#!/bin/sh
# Sync ~/CLAUDE.md into repo with source frontmatter

SOURCE="$HOME/CLAUDE.md"
REPO_ROOT="$(git rev-parse --show-toplevel)"
TARGET="$REPO_ROOT/CLAUDE.md"
REPO_NAME="$(basename "$REPO_ROOT")"

if [ ! -f "$SOURCE" ]; then
    exit 0
fi

FRONTMATTER="# $REPO_NAME — CLAUDE.md

> **Source**: Copied from \`~/CLAUDE.md\` (workspace root).
> This is the shared project config that applies across all workspace projects.
> Edit the original at \`~/CLAUDE.md\` — this copy is for reference within the $REPO_NAME repo."

# Strip the auto-generated claude-mem-context block and the heading line, then prepend frontmatter
BODY=$(sed '1d; /<claude-mem-context>/,/<\/claude-mem-context>/d' "$SOURCE")
CONTENT="$FRONTMATTER
$BODY"

if [ -f "$TARGET" ]; then
    EXISTING=$(cat "$TARGET")
    if [ "$CONTENT" = "$EXISTING" ]; then
        exit 0
    fi
fi

printf '%s\n' "$CONTENT" > "$TARGET"
git add CLAUDE.md
