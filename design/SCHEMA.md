# nmem — Database Schema

SQLite with SQLCipher encryption. Versioned via `rusqlite_migration` `user_version` PRAGMA (2 migrations).

## Tables

### sessions
| Column | Type | Notes |
|--------|------|-------|
| id | TEXT PK | Claude Code session UUID |
| project | TEXT NOT NULL | Derived from cwd |
| started_at | INTEGER NOT NULL | Unix timestamp |
| ended_at | INTEGER | Set by Stop hook |
| signature | TEXT | JSON obs_type counts, set at Stop |
| summary | TEXT | JSON `SessionSummary` from LLM, set at Stop |

### prompts
| Column | Type | Notes |
|--------|------|-------|
| id | INTEGER PK | Auto-increment |
| session_id | TEXT FK → sessions | |
| timestamp | INTEGER NOT NULL | Unix timestamp |
| source | TEXT NOT NULL | `user` (user prompts) or `agent` (thinking blocks) |
| content | TEXT NOT NULL | Truncated to 2000 chars |

### observations
| Column | Type | Notes |
|--------|------|-------|
| id | INTEGER PK | Auto-increment |
| session_id | TEXT FK → sessions | |
| prompt_id | INTEGER FK → prompts | Links observation to causal intent |
| timestamp | INTEGER NOT NULL | Unix timestamp |
| obs_type | TEXT NOT NULL | See obs_types in CLAUDE.md |
| source_event | TEXT NOT NULL | Hook event name (e.g. `PostToolUse`) |
| tool_name | TEXT | Claude Code tool (e.g. `Bash`, `Edit`) |
| file_path | TEXT | When applicable |
| content | TEXT NOT NULL | Extracted content, secret-filtered |
| metadata | TEXT | JSON, includes `redacted: true` if filtered |
| is_pinned | INTEGER NOT NULL DEFAULT 0 | Exempt from retention sweeps |

### _cursor
| Column | Type | Notes |
|--------|------|-------|
| session_id | TEXT PK | |
| line_number | INTEGER NOT NULL DEFAULT 0 | Transcript scan position |

## FTS5 Indexes

External content FTS5 with porter stemming and unicode61 tokenizer.

- **observations_fts** — indexes `observations.content`, synced via insert/delete/update triggers
- **prompts_fts** — indexes `prompts.content`, synced via insert/delete triggers

## Regular Indexes

| Index | Columns | Purpose |
|-------|---------|---------|
| idx_obs_dedup | session_id, obs_type, file_path, timestamp | Dedup check at write time |
| idx_obs_session | session_id, timestamp | Session-scoped queries |
| idx_obs_prompt | prompt_id | Prompt → observation joins |
| idx_obs_type | obs_type | Type-filtered queries |
| idx_obs_file | file_path (WHERE NOT NULL) | File-scoped queries |
| idx_prompts_session | session_id, id | Session-scoped prompt queries |

## SessionSummary JSON structure

Stored in `sessions.summary`. Generated by `s14_summarize.rs` via local LLM.

```json
{
  "intent": "What was being accomplished",
  "learned": ["Decisions, trade-offs, conclusions to not re-derive"],
  "completed": ["What was done"],
  "next_steps": ["What logically follows"],
  "files_read": ["paths"],
  "files_edited": ["paths"],
  "notes": "Failed approaches, errors, negative knowledge"
}
```

Fields use `string_or_vec` deserialization — accepts either a string or array (small model tolerance).
